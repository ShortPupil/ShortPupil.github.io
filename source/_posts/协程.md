---
title: 协程
tags:
  - go
copyright: true
categories: go
abbrlink: bb1e53b0
date: 2020-03-12 11:47:24
---





## 协程

进程、线程会遇到的性能问题：

- 同步锁
- 涉及到线程阻塞状态和可运行状态之间的切换
- 设置到线程上下文的切换

协程是一种比线程更加轻量级的，正如一个进程可以拥有多个线程一样，一个线程可以拥有多个协程。

![img](https://upload-images.jianshu.io/upload_images/4933701-4a7846c5d7c1290c.png?imageMogr2/auto-orient/strip|imageView2/2/w/646/format/webp)

协程是**用户态**的，完全由程序所控制的。好处是性能大幅度的提升，因为不会像线程切换那样消耗资源。

协程可看成某种特殊的函数，这个函数可以在某个地方挂起，并且可以重新在挂起处外继续运行。

因此，通常说一个线程包含多个协程，是指一个线程内可以由多个这样的特殊函数在运行，但是有一点必须明确的是，一个线程的多个协程的运行是**串行**的。如果是多核CPU，多个进程或一个进程内的多个线程是可以并行运行的，但是一个线程内协程却绝对是串行的，无论CPU有多少个核。毕竟协程虽然是一个特殊的函数，但仍然是一个函数。一个线程内可以运行多个函数，但这些函数都是串行运行的。当一个协程运行时，其它协程必须挂起。



### 进程、线程、协程的对比

---

- 协程既不是进程也不是线程，协程仅仅是一个**特殊的函数**
- 一个进程可以包含多个线程，一个线程可以包含多个协程
- 一个线程内的多个协程虽然可以切换，但是多个协程是**串行执行**的，只能在一个线程内运行，没法利用CPU多核能力。
- 协程与进程一样，切换也需要上下文切换



### 协程上下文切换

---

- 进程切换对象是操作系统，内容包括页全局目录、内核栈、硬件上下文，切换内容保存在内存中。进程切换是由“用户态到内核态到用户态”的方式，切换效率低
- 线程切换对象是操作系统，切换时机是os设置的切换恶略。线程的切换内容包括内核栈和硬件上下文。线程切换内容保存在内核栈中。线程切换过程是由“用户态到内核态到用户态”， 切换效率中等。
- 协程切换者是用户（准确的说是用户态的操作者，可以是编译器或应用程序），切换时机是用户自己的程序决定的。协程切换内容是硬件上下文，切换内存保存在用户自己的变量（用户堆、栈）中。切换过程只有用户态，即没有陷入内核态，因此切换效率更高。

































